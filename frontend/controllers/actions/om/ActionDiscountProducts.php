<?php
namespace frontend\controllers\actions\om;

use common\models\OrdersProducts;
use common\models\PartnersProducts;
use common\models\PartnersProductsAttributes;
use common\models\PartnersProductsOptionVal;
use common\models\PartnersProductsToCategories;
use Yii;
use yii\data\ActiveDataProvider;
use yii\db\Query;
use yii\helpers\ArrayHelper;

trait ActionDiscountProducts
{
    public function actionDiscountproducts()
    {

               $actionproducts = [
                    960705218,
                    960705219,
                    960705363,
                    960705364,
                    960705366,
                    960705367,
                    960705387,
                    960705391,
                    960705393,
                    960705394,
                    960705475,
                    960705497,
                    960705498,
                    960705505,
                    960705507,
                    960705536,
                    960705539,
                    960705544,
                    960706441,
                    960778996,
                    960706465,
                    960706766,
                    960706769,
                    960706770,
                    960706773,
                    960706774,
                    960706775,
                    960707187,
                    960710521,
                    960710522,
                    960710523,
                    960710524,
                    960710539,
                    960710541,
                    960710543,
                    960710544,
                    960710545,
                    960710546,
                    960710548,
                    960710565,
                    960710575,
                    960710576,
                    960710578,
                    960710580,
                    960710598,
                    960710601,
                    960710603,
                    960710608,
                    960710613,
                    960710615,
                    960710616,
                    960710617,
                    960710618,
                    960710624,
                    960710625,
                    960710626,
                    960710627,
                    960710628,
                    960710631,
                    960710632,
                    960710633,
                    960710637,
                    960710638,
                    960710641,
                    960710645,
                    960711798,
                    960711799,
                    960711800,
                    960711801,
                    960711802,
                    960711803,
                    960712188,
                    960712189,
                    960712190,
                    960712191,
                    960712192,
                    960712193,
                    960712194,
                    960712826,
                    960712827,
                    960712828,
                    960712829,
                    960712830,
                    960712834,
                    960712835,
                    960712836,
                    960712837,
                    960712850,
                    960713858,
                    960713869,
                    960713925,
                    960714368,
                    960714369,
                    960714371,
                    960714382,
                    960714383,
                    960714458,
                    960714459,
                    960714460,
                    960714492,
                    960714493,
                    960714736,
                    960714833,
                    960714834,
                    960715172,
                    960715182,
                    960715183,
                    960715184,
                    960715185,
                    960715186,
                    960715191,
                    960715192,
                    960715223,
                    960715224,
                    960715225,
                    960715250,
                    960715276,
                    960715307,
                    960715308,
                    960715324,
                    960715330,
                    960715371,
                    960715372,
                    960715373,
                    960715378,
                    960715379,
                    960715380,
                    960715381,
                    960715382,
                    960715383,
                    960715384,
                    960715386,
                    960715387,
                    960715389,
                    960715392,
                    960715395,
                    960715402,
                    960715403,
                    960715404,
                    960715405,
                    960715406,
                    960715407,
                    960715408,
                    960715410,
                    960715412,
                    960715413,
                    960715414,
                    960715416,
                    960715418,
                    960715419,
                    960715426,
                    960715441,
                    960715458,
                    960715467,
                    960715476,
                    960715478,
                    960715486,
                    960715517,
                    960715533,
                    960715534,
                    960715536,
                    960715537,
                    960715538,
                    960715539,
                    960715540,
                    960715541,
                    960715543,
                    960715544,
                    960715545,
                    960715546,
                    960715548,
                    960715549,
                    960715837,
                    960715868,
                    960715869,
                    960715881,
                    960715882,
                    960715884,
                    960715885,
                    960715889,
                    960715891,
                    960715892,
                    960715893,
                    960715894,
                    960715895,
                    960715896,
                    960715897,
                    960715899,
                    960715903,
                    960779180,
                    960779181,
                    960779176,
                    960779178,
                    960715931,
                    960715933,
                    960779167,
                    960779168,
                    960779170,
                    960779164,
                    960779157,
                    960779159,
                    960779160,
                    960715947,
                    960715948,
                    960715949,
                    960715950,
                    960715951,
                    960715952,
                    960715955,
                    960715962,
                    960715976,
                    960715979,
                    960715980,
                    960715983,
                    960715984,
                    960715986,
                    960715990,
                    960715996,
                    960715997,
                    960716000,
                    960716322,
                    960974035,
                    960974029,
                    960974031,
                    960974032,
                    960974034,
                    960974178,
                    960716411,
                    960716408,
                    960974180,
                    960716428,
                    960716524,
                    960716984,
                    960716985,
                    960716986,
                    960716987,
                    960717047,
                    960717683,
                    960717719,
                    960974286,
                    960974287,
                    960974288,
                    960974289,
                    960974290,
                    960974291,
                    960773827,
                    960773835,
                    960773836,
                    960773837,
                    960774124,
                    960774180,
                    960774330,
                    960774331,
                    960774332,
                    960774333,
                    960774334,
                    960774335,
                    960774336,
                    960774337,
                    960774338,
                    960774339,
                    960774341,
                    960774342,
                    960774343,
                    960774344,
                    960774345,
                    960774348,
                    960774352,
                    960774353
                ];

        $list = array();
        $hide_man = $this->hide_manufacturers_for_partners();
        foreach ($hide_man as $value) {
            $list[] = $value['manufacturers_id'];
        }

        $hide_man = implode(',', $list);
        $orderedproducts = new ActiveDataProvider([
            'query' => PartnersProducts::find()->select('products.products_id')->where(['products.products_model' => $actionproducts])->andWhere('products.manufacturers_id NOT IN (' . $hide_man . ') and products.products_status=1  and products.products_quantity > 0 and products.products_price>0')->groupBy('`products_id` DESC'),
            'pagination' => [
                'defaultPageSize' => 60,
                'pageSizeLimit' => [0, 60]
            ],
        ]);
        $pagination = $orderedproducts->getPagination();
        $orprod = [];
        $gmorprod = $orderedproducts->getModels();
        foreach ($gmorprod as $key => $value) {
            if (!in_array($value['products_id'], $orprod)) {
                $orprod[] = $value['products_id'];
            }
        }

        if ($orprod) {
            $orprodstring = implode(',', $orprod);

            $opprovider = new ActiveDataProvider([
                'query' => PartnersProducts::find()->joinWith('productsDescription')->joinWith('productsAttributes')->joinWith('productsAttributesDescr')->where('products.products_id IN (' . $orprodstring . ')')->distinct(),
                'pagination' => [
                    'defaultPageSize' => 60,
                    'pageSizeLimit' => [0, 60]
                ],
            ]);
            $orderedproducts = $opprovider->getModels();
        } else {
            $orderedproducts = [];
        }

        $catpath = ['num' => ['0' => 0], 'name' => ['0' => 'Каталог']];
        $man_time = $this->manufacturers_diapazon_id();

        return $this->render('lkorderedproducts', ['orderedproducts' => $orderedproducts, 'pagination' => $pagination, 'catpath' => $catpath, 'man_time' => $man_time, 'title'=>'Акционные товары']);
    }
}